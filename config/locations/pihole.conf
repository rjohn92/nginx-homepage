# Redirect bare path to a trailing slash
location = /pihole { return 301 /pihole/; }

location ^~ /pihole/api/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header Accept-Encoding "";
    gzip off;

    proxy_pass http://pihole/admin/api/;
    proxy_redirect /admin/ /pihole/;
    proxy_cookie_path /admin/ /pihole/;
}

location ^~ /pihole/ {
    # (Temporarily keep SSO off until it works)
    # auth_request /oauth2/auth;
    # error_page 401 = @oauth2_redirect;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

    proxy_http_version 1.1;
    proxy_read_timeout 300;
    proxy_send_timeout 300;
    proxy_buffering off;

    # IMPORTANT: upstream is /admin/ with trailing slash
    # If nginx shares a Docker network with pihole:
    proxy_pass http://pihole/admin/;
    # Or, if you prefer host port:
    # proxy_pass http://192.168.X.Y:81/admin/;

    # 1) Rewrite upstream redirects: /admin/... -> /pihole/...
    proxy_redirect /admin/ /pihole/;

    # 2) Make Pi-hole's session cookie valid under /pihole/
    proxy_cookie_path / /pihole/;

    # 3) Let sub_filter actually work by disabling upstream gzip
    proxy_set_header Accept-Encoding "";   # <â€” critical
    gzip off;

    # 4) Rewrite absolute URLs inside HTML/CSS/JS
    sub_filter_once off;
    sub_filter_types text/html text/plain text/css application/javascript application/json;
    sub_filter 'href="/'   'href="/pihole/';
    sub_filter 'src="/'    'src="/pihole/';
    sub_filter 'action="/' 'action="/pihole/';
}
