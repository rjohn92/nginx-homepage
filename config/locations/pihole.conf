location = /pihole {
    return 301 /pihole/;
}

# API: /api/...  ->  http://pihole/api/  (explicit trailing slash)
location ^~ /api/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header Cookie            $http_cookie;

    proxy_pass http://pihole/api/;      # or http://192.168.1.154:81/api/

    # Cookie must be valid for root so the browser sends it to /api/*
    proxy_cookie_path /admin/ /;

    proxy_http_version 1.1;
    proxy_buffering off;

    proxy_cookie_flags sid Secure HttpOnly SameSite=Lax;
}


# UI: /pihole/...  ->  http://pihole/admin/
location ^~ /pihole/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host  $host;

    proxy_pass http://pihole/admin/;    # or http://192.168.1.154:81/admin/
    proxy_redirect /admin/ /pihole/;
    proxy_cookie_path /admin/ /;

    proxy_set_header Accept-Encoding ""; # for HTML rewrite only
    gzip off;
    sub_filter_once off;
    sub_filter 'href="/admin/'   'href="/pihole/';
    sub_filter 'src="/admin/'    'src="/pihole/';
    sub_filter 'action="/admin/' 'action="/pihole/';

    proxy_http_version 1.1;
    proxy_buffering off;
}

# Safety: anything that hits /admin/* externally gets bounced under /pihole/*
location ^~ /admin/ { return 301 /pihole$request_uri; 
}

